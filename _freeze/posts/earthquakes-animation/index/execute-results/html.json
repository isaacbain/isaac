{
  "hash": "feb2f68a571e590d3a879e342d98a70b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Earthquakes animation\"\nauthor: \"Isaac Bain\"\ndate: \"2024-06-10\"\ncategories: [code, geophysics, maps, animation]\nexecute:\n  warning: false\n  error: false\nformat: \n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n    toc: true\n    toc-location: left\n    number-sections: true\neditor: visual\n---\n\n\n## Data source\n\nGeoNet is a partnernship between Toka Tū Ake EQC, GNS Science, and Land Information New Zealand (LINZ) which has been around since 2001. It is a geological hazard monitoring system that uses a network of geophysical instruments to detect earthquakes, volcanic activity, large landslides, tsunami, and slow-slip events that precede large earthquakes.\n\nThey make their data available in a number of API formats. Here, I use a Web Feature Service (WFS) to query the GeoNet Earthquake Catalogue for earthquakes that happened (1) last year, (2) were greater than magnitude one, (3) occurred in or near New Zealand.\n\nThe API bypasses the CSV download limit on their website, and the data can be directly read into R as a Simple Features (sf) spatial object.\n\nLibraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(httr)\nlibrary(gganimate)\nlibrary(patchwork)\nlibrary(ggtext)\n```\n:::\n\n\nDownload data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwfs_url <- \"https://wfs.geonet.org.nz/geonet/ows\"\ntype_name <- \"geonet:quake_search_v1\"\noutput_format <- \"json\"\ncql_filter <- \"origintime>='2023-01-01T00:00:00.000Z' AND origintime<'2024-01-01T00:00:00.000Z' AND magnitude>1.5\"\n\nquery_url <- paste0(\n  wfs_url,\n  \"?service=WFS&version=1.0.0&request=GetFeature&typeName=\", type_name,\n  \"&outputFormat=\", output_format,\n  \"&cql_filter=\", URLencode(cql_filter)\n)\n\nearthquakes_sf <- st_read(query_url) |> st_transform(2193)\n\ncoastline <- st_read(\"data/coastline_simplified/nz-coastlines-and-islands-polygons-topo-150k.shp\", crs = 2193)\n```\n:::\n\n\nCrop data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbbox <- st_as_sfc(st_bbox(c(xmin = 166, ymin = -47.5, xmax = 180, ymax = -33))) |>\n  st_set_crs(4326) |>\n  st_transform(2193)\n\nearthquakes_nz_sf <- st_intersection(earthquakes_sf, bbox)\n\ncoastline <- st_crop(coastline, bbox)\n```\n:::\n\n\n## Exploratory data analysis\n\n### Depth and magnitude\n\nFirstly, let's examine the distribution of earthquake depths and magnitudes (@fig-depth-and-magnitude). It's evident that there are more shallow earthquakes than deep ones, and more small earthquakes than large ones.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_depth <- ggplot(earthquakes_nz_sf, aes(x = depth)) +\n  geom_histogram(aes(fill = ..x..), bins = 30, color = \"black\", alpha = 0.7) +\n  theme_minimal() +\n  labs(\n    title = \"Distribution of Depths\",\n    x = \"Depth (km)\",\n    y = \"Count\"\n  ) +\n  scale_fill_viridis_c(option = \"inferno\", direction = -1) +\n  theme(\n    axis.text.x = element_text(vjust = 0.5, hjust = 0.5),\n    legend.position = \"bottom\",\n    legend.title = element_blank()\n  )\n\nbin_data <- earthquakes_nz_sf %>%\n  mutate(bin = cut(magnitude, breaks = seq(min(magnitude), max(magnitude), length.out = 31), include.lowest = TRUE)) %>%\n  group_by(bin) %>%\n  summarise(\n    magnitude = mean(magnitude),\n    count = n(),\n    magnitude_exp = mean(exp(magnitude))\n  )\n\nplot_magnitude <- ggplot(earthquakes_nz_sf, aes(x = magnitude)) +\n  geom_histogram(aes(y = ..count..), bins = 30, fill = \"darkslateblue\", color = \"black\", alpha = 0.7) +\n  # geom_point(data = bin_data, aes(x = magnitude, y = count, size = magnitude_exp),\n  #            color = \"black\", alpha = 0.5) +\n  theme_minimal() +\n  labs(\n    title = \"Distribution of Magnitudes\",\n    x = \"Magnitude\",\n    y = \"Count\"\n  ) +\n  scale_x_continuous(\n    breaks = c(1, 2, 3, 4, 5, 6, 7),\n    labels = c(\"1\\nUnnoticeable\", \"2\\nUnnoticeable\", \"3\\nWeak\", \"4\\nLight\", \"5\\nModerate\", \"6\\nStrong\", \"7\\nSevere\")\n  ) +\n  scale_size_continuous(\n    name = \"Magnitude\",\n    range = c(3, 15),\n    breaks = exp(c(3, 4, 5, 6)),\n    labels = c(\"≤ 3\", 4, 5, \"≥ 6\")\n  ) +\n  theme(\n    axis.text.x = element_text(vjust = 0.5, hjust = 0.5),\n    legend.position = \"bottom\",\n    legend.title = element_blank()\n  )\n\nplot_depth + plot_magnitude\n```\n\n::: {.cell-output-display}\n![Distribution of depths and magnitudes of earthquakes in New Zealand, 2023.](index_files/figure-html/fig-depth-and-magnitude-1.png){#fig-depth-and-magnitude width=960}\n:::\n:::\n\n\n### Depth vs magnitude\n\nLet's take this one step further and examine the relationship between depth and magnitude (@fig-depth-vs-magnitude). Large, shallow earthquakes are the most dangerous, causing significant damage. Whilst, small, deep earthquakes are less likely to be felt by people, and there are few of these in the dataset—possibly because they are harder for seismometers to detect.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = earthquakes_nz_sf, aes(magnitude, depth)) +\n    geom_point(aes(color = depth > 35), alpha = 0.1) +\n  scale_color_manual(values = c(\"TRUE\" = \"darkorange\", \"FALSE\" = \"darkslateblue\")) +\n  geom_hline(yintercept = 35, linetype = \"dashed\") +\n  theme_minimal() +\n  labs(\n    x = \"Magnitude\",\n    y = \"Depth (km)\",\n    title = \"Earthquake depth versus magnitude\",\n    subtitle = \"Dashed line at 35 km depth boundary between <span style='color:darkslateblue;'><b>crustal</b></span> and <span style='color:darkorange;'><b>subduction</b></span> earthquakes\"\n  ) +\n  annotate(\n    geom = \"curve\", x = 5.5, y = 200, xend = 5.9, yend = 50,\n    curvature = .3, arrow = arrow(length = unit(2, \"mm\"))\n  ) +\n  annotate(geom = \"text\", x = 5.5, y = 215, label = \"Shallow & strong!\", hjust = \"center\") +\n  annotate(\n    geom = \"curve\", x = 1.75, y = 450, xend = 1.75, yend = 500,\n    curvature = .3, arrow = arrow(length = unit(2, \"mm\"))\n  ) +\n  annotate(geom = \"text\", x = 1.75, y = 440, label = \"No worries\", hjust = \"center\") +\n  annotate(geom = \"text\", x = 6.5, y = 50, label = \"35km\", hjust = \"center\") +\n  theme(\n    legend.position = \"none\",\n    plot.subtitle = ggtext::element_markdown()\n  )\n```\n\n::: {.cell-output-display}\n![Earthquake depth versus magnitude in New Zealand, 2023. Dashed line at 35 km depth boundary between crustal and subduction earthquakes.](index_files/figure-html/fig-depth-vs-magnitude-1.png){#fig-depth-vs-magnitude width=672}\n:::\n:::\n\n\n```         \n```\n\n## Mapping\n\n### Crustal vs subduction earthquakes\n\nDeep earthquakes under the North Island form a well-defined line, representing the Hikurangi subduction zone where the Pacific Plate is being forced under the Australian Plate (@fig-crustal-subduction). This pattern, with deeper earthquakes towards the west of the North Island, is the Wadati–Benioff zone.\n\nIn contrast, the South Island exhibits a different earthquake pattern, with the Australian Plate being forced under the Pacific Plate. This is the Alpine Fault, a transform fault responsible for the Southern Alps. The deeper earthquakes occur on the southeast edge of the Wadati–Benioff zone, where it dips steeply to the southeast.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# https://www.otago.ac.nz/geology/research/alpine-fault\n\nplot_crustal <- ggplot() +\n  geom_sf(\n    data = coastline,\n    fill = \"#839073\",\n    color = NA\n  ) +\n  geom_sf(\n    data = earthquakes_nz_sf |> filter(depth < 35),\n    colour = \"darkslateblue\",\n    size = 0.1,\n    alpha = 0.7\n  ) +\n  coord_sf(xlim = c(1050000, 2200000), ylim = c(4700000, 6200000)) +\n  theme_void() +\n  labs(\n    title = \"<span style='color:darkslateblue'>Crustal</span> earthquakes <br>< 35km deep\",\n    x = \"\",\n    y = \"\"\n  ) +\n  theme(plot.title = element_markdown(\n    family = \"sans\", size = 12, face = \"bold\", color = \"#394053\", hjust = 0.5\n  )) +\n    annotate(\n    \"curve\", x = 1680000, y = 5746015, xend = 1851604, yend = 5703141,\n    curvature = .3, arrow = arrow(length = unit(2, \"mm\")), color = \"black\",\n    linewidth = 0.25\n  ) +\n  annotate(\n    \"text\", x = 1670000, y = 5746015, label = \"Taupō volcanic zone\", hjust = \"right\", color = \"black\", size = 2.5\n  ) +\n    annotate(\n    \"curve\", x = 1894962, y = 6057348, xend = 1969587, yend = 5839512,\n    curvature = .3, arrow = arrow(length = unit(2, \"mm\")), color = \"black\",\n    linewidth = 0.25\n  ) +\n  annotate(\n    \"text\", x = 1894962, y = 6057348, label = \"Whakaari \\nWhite Island\", hjust = \"centre\",\n    vjust = -0.15, color = \"black\", size = 2.5\n  )\n\nplot_subduction <- ggplot() +\n  geom_sf(\n    data = coastline,\n    fill = \"#839073\",\n    color = NA\n  ) +\n  geom_sf(\n    data = earthquakes_nz_sf |> filter(depth > 35),\n    aes(color = depth),\n    size = 0.1,\n    alpha = 0.7\n  ) +\n  coord_sf(xlim = c(1050000, 2200000), ylim = c(4700000, 6200000)) +\n  theme_void() +\n  labs(\n    title = \"<span style='color:darkorange'>Subduction</span> earthquakes <br>&gt; 35km deep\",\n    x = \"\",\n    y = \"\",\n    color = \"Depth (km)\",\n    size = \"Magnitude\"\n  ) +\n  theme(\n    plot.title = element_markdown(\n      family = \"sans\", size = 12, face = \"bold\", color = \"#394053\", hjust = 0.5\n    ),\n    legend.position = \"bottom\"\n  ) +\n  scale_color_viridis_c(option = \"inferno\", direction = -1) +\n    annotate(\n    \"curve\", x = 1680000, y = 5000000, xend = 1450000, yend = 5200000,\n    curvature = .3, arrow = arrow(length = unit(2, \"mm\")), color = \"black\",\n    linewidth = 0.25\n  ) +\n  annotate(\n    \"text\", x = 1680000, y = 4930000, label = \"Notable gap in deep \\nearthquakes\", hjust = 0.5, color = \"black\", size = 2.5\n  )\n\nplot_crustal + plot_subduction\n```\n\n::: {.cell-output-display}\n![Crustal and subduction earthquakes in New Zealand, 2023. The Hikurangi subduction zone is visible under the North Island, and the Alpine Fault under the South Island.](index_files/figure-html/fig-crustal-subduction-1.png){#fig-crustal-subduction width=672}\n:::\n:::\n\n\n### Static map\n\nLet's plot all of the earthquakes on a map of New Zealand (@fig-static). We'll use the `geom_sf` function to plot the earthquakes and the coastline. Additionally we'll use the `scale_size_continuous` function to adjust the size of the points based on the magnitude of the earthquake, applying an exponential transformation to reflect the disproportionately larger amount of energy released by larger magnitude earthquakes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(\n    data = coastline,\n    fill = \"#839073\",\n    color = NA\n  ) +\n  geom_sf(\n    data = earthquakes_nz_sf,\n    aes(color = depth, size = exp(magnitude)),\n    alpha = 0.2\n  ) +\n  scale_size_continuous(\n    name = \"Magnitude\",\n    range = c(0.01, 8),\n    breaks = exp(c(3, 4, 5, 6)),\n    labels = c(\"≤ 3\", 4, 5, \"≥ 6\")\n  ) +\n  coord_sf(xlim = c(1050000, 2200000), ylim = c(4700000, 6200000)) +\n  theme_void() +\n  labs(\n    title = \"Earthquakes in New Zealand (2023)\",\n    x = \"\",\n    y = \"\",\n    color = \"Depth (km)\",\n    size = \"Magnitude\"\n  ) +\n  theme(plot.title = element_text(\n    family = \"sans\", size = 12, face = \"bold\", color = \"#394053\", hjust = 0.5, vjust = 2.5\n  )) +\n  scale_color_viridis_c(\n    option = \"inferno\",\n    direction = -1\n  )\n```\n\n::: {.cell-output-display}\n![Earthquakes in New Zealand, 2023. The size of the points represents the magnitude of the earthquake, and the colour represents the depth.](index_files/figure-html/fig-static-1.png){#fig-static width=576}\n:::\n:::\n\n\n### Animated plot\n\nNow, to make it animated! We'll use the `gganimate` package to create an animated plot of the earthquakes over time (@fig-animated). We'll use the `transition_time` function to animate the plot over the `origintime` variable, which is the date of the earthquake. Additionally, we'll use the `shadow_mark` function to leave a shadow of the earthquakes that have already occurred.\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- ggplot() +\n  geom_sf(\n    data = coastline,\n    fill = \"#839073\",\n    color = NA\n  ) +\n  geom_sf(\n    data = earthquakes_nz_sf,\n    aes(color = depth, size = exp(magnitude)),\n    alpha = 0.4\n  ) +\n  scale_size_continuous(\n    name = \"Magnitude\",\n    range = c(0.01, 6), \n    breaks = exp(c(3, 4, 5, 6)),\n    labels = c(\"≤ 3\", 4, 5, \"≥ 6\")\n  ) +\n  coord_sf(xlim = c(1050000, 2200000), ylim = c(4700000, 6200000)) +\n  theme_void() +\n  labs(\n    title = \"Earthquakes in New Zealand (2023)\",\n    subtitle = \"Date: {lubridate::as_date(next_state)}\",\n    x = \"\",\n    y = \"\",\n    color = \"Depth (km)\",\n    size = \"Magnitude\"\n  ) +\n  scale_color_viridis_c(\n    option = \"inferno\",\n    direction = -1\n  ) +\n  theme(\n    plot.title = element_text(family = \"sans\", size = 12, face = \"bold\", color = \"#394053\",\n                              hjust = 0.5),\n    plot.subtitle = element_text(size = 8, hjust = 0.5),\n    legend.title = element_text(size = 8)\n  ) +\n  guides(color = guide_colourbar(reverse = T)) +\n  transition_states(origintime, transition_length = 2, state_length = 1) +\n  shadow_mark(past = TRUE)\n\nanimate(p,\n  start_pause = 15,\n  end_pause = 60,\n  nframes = 300,\n  fps = 20,\n  res = 300,\n  renderer = gifski_renderer()\n)\n```\n\n::: {.cell-output-display}\n![Animated plot of earthquakes in New Zealand, 2023. The size of the points represents the magnitude of the earthquake, and the colour represents the depth.](index_files/figure-html/fig-animated-1.gif){#fig-animated}\n:::\n:::\n\n\n## Conclusion\n\nSo that's it! We've explored the earthquakes in New Zealand in 2023, focusing on their distribution, the relationship between depth and magnitude, and the spatial patterns relative to tectonic plate boundaries. We've created static and animated visualisations to enhance our understanding of the data and effectively communicate our findings.\n\nNext steps could include further analysis of the data, such as:\n\n-   Clustering the earthquakes to identify regions of high seismic activity.\n-   Exploring the relationship between earthquakes and other geophysical data, such as volcanic activity or fault lines.\n-   Plotting seismograms to visualise the seismic waves generated by particular earthquakes.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
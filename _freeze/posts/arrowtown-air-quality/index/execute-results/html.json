{
  "hash": "a71beea8e17db86f7b81562c2522edd4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Arrowtown air quality\"\nauthor: \"Isaac Bain\"\ndate: \"2024-06-02\"\ncategories: [code, air quality, animation]\nexecute:\n  warning: false\n  error: false\nformat: \n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n    toc: true\n    toc-location: left\n    number-sections: true\neditor: visual\n---\n\n\nMost of the time, New Zealand enjoys good air quality, allowing us to step outside and breathe a breath of fresh air, knowing it's safe. However at certain times and places, our air is polluted to such levels that it causes us harm, or in the worst cases, premature death. Here I access air quality data from LAWA and explore it for one site known for severe winter air pollution.\n\n## Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # provides ggplot, dplyr, etc\nlibrary(janitor) # tidy up messy variable names\nlibrary(gganimate) # provides animations\nlibrary(geomtextpath) # makes labels curved on polar graph\nlibrary(leaflet) # for interactive mapping\n```\n:::\n\n\n## Import data\n\n[Land, Air, Water Aotearoa (LAWA)](https://lawa.org.nz/) is a collaboration between New Zealand's 16 regional councils and unitary authorities, the Cawthron Institute, the Ministry for the Environment, the Department of Conservation, and Stats NZ. LAWA provides state of the environment monitoring data for various [environmental domains](https://lawa.org.nz/explore-data), including; swimming water quality, estuary health, groundwater quality, lake quality, land cover, river quality, water quantity, and of particular interest here, air quality.\n\nLAWA makes their data freely available at <https://lawa.org.nz/download-data>. From this source I downloaded an Excel sheet of air quality data for the period 2016 to 2022. Currently, the available parameters are PM~10~ and PM~2.5~.\n\nParticulate matter (PM) can have adverse effects on human health and the environment. The numbers 10 and 2.5 refer to the diameter of the particles in micrometers (µm).\n\n::: {.callout-note collapse=\"false\"}\n## What are the human health impacts of PM in New Zealand?\n\nHales et al. (2021) did a retrospective cohort epidemiological study of the association between PM~2.5~, NO~2~ and mortality and morbidity for 2.2m New Zealanders. They found that exposure to PM~2.5~ per 10 μg/m^3^ increased the risk of death by 11% (95% CI 7-15%) and increased the risk of ischaemic heart disease by 29% (95% CI 23-35%).\n\nHales, S., Atkinson, J., Metcalfe, J., Kuschel, G., & Woodward, A. (2021). Long term exposure to air pollution, mortality and morbidity in New Zealand: cohort study. *Science of The Total Environment, 801*, 149660.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- readxl::read_xlsx(\"data/airqualitydownloaddata_2016-2022.xlsx\",\n                         sheet = \"Air Quality Data\") |> # read in data\n  clean_names() |> # tidy up messy names\n  mutate(year = year(sample_date)) |> # extract year as a new variable\n  filter(!is.na(sample_date) & !is.na(concentration)) # filter out NAs\n```\n:::\n\n\n## What are the worst sites?\n\nAir quality is known to be worst in more southern areas, places where home heating via wood burning or coal is more prevalent, particularly during the colder months of the year.\n\nBut let's check some of these assumptions by extracting the worst 5 sites for highest recorded PM~10~ values (@tbl-top5).\n\n\n\n::: {#tbl-top5 .cell tbl-cap='Top 5 sites with highest PM~10~ concentrations'}\n\n```{.r .cell-code}\ndat |> \n  filter(indicator == \"PM10\") |> # just look at PM10\n  group_by(site_name) |> \n  summarize(max_concentration = max(concentration, na.rm = TRUE)) |> # get max conc. per site\n  arrange(desc(max_concentration)) |> # sort descending\n  top_n(5, max_concentration) |> # get top 5 sites\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|site_name                       | max_concentration|\n|:-------------------------------|-----------------:|\n|Milton                          |           202.800|\n|Arrowtown                       |           157.900|\n|Lower Hutt (Phil Evans Reserve) |           155.400|\n|Invercargill at Pomona Street   |           138.980|\n|Washdyke Alpine                 |           123.496|\n\n\n:::\n:::\n\n\nIndeed most of these locations are in South Island, with the exception of Lower Hutt, which is at the southern end of the North Island.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprocessed_data <- dat %>% \n  filter(indicator == \"PM10\") %>% # just look at PM10\n  group_by(site_name) %>% \n  summarise(\n    max_concentration = max(concentration, na.rm = TRUE), \n    latitude = first(latitude),\n    longitude = first(longitude)\n  ) %>% # get max conc. per site\n  arrange(desc(max_concentration)) %>% # sort descending\n  top_n(5, max_concentration) %>% \n  sf::st_as_sf(coords = c(\"longitude\", \"latitude\"), crs = 4326)\n\n# Create a color palette\npal <- colorNumeric(\n  palette = \"YlOrRd\",\n  domain = processed_data$max_concentration, # Set the domain to the range of max_concentration\n  na.color = \"transparent\",\n  reverse = TRUE\n)\n\n# Create a Leaflet map\nleaflet(processed_data) %>%\n  addTiles() %>%\n  addCircleMarkers(\n    radius = ~sqrt(max_concentration), # Scale the radius proportional to max_concentration\n    color = ~pal(max_concentration),\n    fillOpacity = 1,\n    stroke = 0,\n    label = ~paste0(site_name, \", \", \"Max PM10: \", max_concentration)\n  ) %>%\n  addLegend(\n    \"bottomright\",\n    pal = pal,\n    values = processed_data$max_concentration, # Pass the actual max_concentration values\n    title = \"Max PM10 Concentration\",\n    opacity = 0.7,\n    labFormat = labelFormat(transform = function(x) sort(x, decreasing = TRUE))\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-994aa6d462e5cf52ee22\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-994aa6d462e5cf52ee22\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addCircleMarkers\",\"args\":[[-46.12132792,-44.94857127,-41.2126069999999,-46.43192839,-44.356199],[169.9615016,168.84573717,174.920876,168.36991681,171.242334],[14.24078649513432,12.56582667395982,12.46595363379794,11.78897790310933,11.11287541548091],null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":0,\"color\":[\"#FFFFCC\",\"#FD6E32\",\"#FD5E2E\",\"#D21021\",\"#800026\"],\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":[\"#FFFFCC\",\"#FD6E32\",\"#FD5E2E\",\"#D21021\",\"#800026\"],\"fillOpacity\":1},null,null,null,null,[\"Milton, Max PM10: 202.8\",\"Arrowtown, Max PM10: 157.9\",\"Lower Hutt (Phil Evans Reserve), Max PM10: 155.4\",\"Invercargill at Pomona Street, Max PM10: 138.98\",\"Washdyke Alpine, Max PM10: 123.496\"],{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addLegend\",\"args\":[{\"colors\":[\"#800026 , #A80026 8.20135176031474%, #D61220 20.8110561888429%, #F44025 33.4207606173711%, #FD7B36 46.0304650458993%, #FEA747 58.6401694744275%, #FFCD69 71.2498739029557%, #FFE794 83.8595783314839%, #FFFAC0 96.4692827600121%, #FFFFCC \"],\"labels\":[\"200\",\"190\",\"180\",\"170\",\"160\",\"150\",\"140\",\"130\"],\"na_color\":null,\"na_label\":\"NA\",\"opacity\":0.7,\"position\":\"bottomright\",\"type\":\"numeric\",\"title\":\"Max PM10 Concentration\",\"extra\":{\"p_1\":0.08201351760314743,\"p_n\":0.9646928276001209},\"layerId\":null,\"className\":\"info legend\",\"group\":null}]}],\"limits\":{\"lat\":[-46.43192839,-41.2126069999999],\"lng\":[168.36991681,174.920876]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n## Static plot of seasonal air quality\n\nNow let's check the assumption that air quality is worse during the colder months of the year. Here, I plot daily PM~10~ concentrations over 2022 for one site (Arrowtown) (@fig-staticplot). The data shows a significant spike during the winter months, with a number of exceedances of the WHO guideline of 45 µg/m³.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_filtered <- dat |> \n  filter(site_name == \"Arrowtown\") |> \n  filter(indicator == \"PM10\") |> \n  filter(year == 2022) |>\n  arrange(sample_date) |> \n  mutate(sample_date = as.Date(sample_date))\n\n# Calculate the breaks for y-axis labels\nn_breaks <- 5\nmy_breaks <- scales::breaks_extended(n = n_breaks)(range(dat_filtered$concentration))\nmy_breaks <- my_breaks[my_breaks > 0]\n\n# Create a data frame for the tick marks\ntick_data <- data.frame(\n  x = as.Date(\"2022-01-01\"),\n  xend = as.Date(\"2022-01-03\"),\n  y = my_breaks,\n  yend = my_breaks\n)\n\n# plot\nggplot(dat_filtered) +\n  geom_hline(yintercept = 45, linetype = \"dashed\", color = \"red\", alpha = 0.7) +\n  geom_line(aes(x = sample_date, y = concentration),\n            color = \"#D72638\",\n            size = 0.5) +\n  scale_x_date(date_labels = \"%b\", date_breaks = \"1 month\") +\n  labs(\n    title = bquote(\"Daily PM\"[10] * \" concentration (µg/m\"^3 * \") in Arrowtown, 2022\"),\n    x = \"\",\n    y = bquote(\"Daily PM\"[10] * \" concentration (µg/m\"^3 * \")\")\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(hjust = 0.5, \n                              colour = \"#420039\"),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.text.x = element_text(\n      color = \"#12355B\",\n      face = \"bold\",\n      size = 14,\n      vjust = -0.5\n    )\n  ) +\n  annotate(\n    'text',\n    x = as.Date(\"2022-01-03\"),\n    y = my_breaks,\n    label = round(my_breaks, 2),\n    angle = 0,\n    hjust = -0.1,\n    vjust = 0.5\n  ) +\n  geom_segment(data = tick_data,\n               aes(\n                 x = x,\n                 xend = xend,\n                 y = y,\n                 yend = yend\n               ),\n               color = \"black\")\n```\n\n::: {.cell-output-display}\n![PM~10~ daily concentrations at Arrowtown, 2022. Dashed line shows WHO guideline value.](index_files/figure-html/fig-staticplot-1.png){#fig-staticplot width=672}\n:::\n:::\n\n\n## Make an animated plot\n\nLet's enhance our analysis by creating an animated polar chart that reveals the daily PM~10~ concentrations over time (@fig-animation). This approach effectively highlights the cyclical nature of seasonal air quality. By animating the data, we can observe the progression of PM~10~ levels throughout the year, providing a clear visual representation of how air quality deteriorates during the winter months.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define the start dates for each season according to New Zealand definitions\nseason_start_dates <- as.Date(c(\"2022-12-01\", \"2022-03-01\", \"2022-06-01\", \"2022-09-01\"))\n\n# Create the plot with seasonal division lines and y-axis labels inside the chart\np <- ggplot(dat_filtered) +\n  geom_hline(yintercept = 45, linetype = \"dashed\", color = \"red\", alpha = 0.7) +\n  geom_line(aes(x = sample_date, y = concentration),\n            color = \"#D72638\",\n            size = 0.5) +\n  geom_vline(\n    xintercept = as.numeric(season_start_dates),\n    linetype = \"dashed\",\n    color = \"black\",\n    alpha = 0.3\n  ) +\n  geom_point(aes(x = sample_date, y = concentration), color = \"#420039\", size = 2) +\n  scale_x_date(date_labels = \"%b\", date_breaks = \"1 month\") +\n  coord_curvedpolar() +\n  labs(\n    title = bquote(\"Daily PM\"[10] * \" concentration (µg/m\"^3 * \") in Arrowtown, 2022\"),\n    x = \"\",\n    y = \"\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(hjust = 0.5, \n                              colour = \"#420039\"),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.text.x = element_text(\n      color = \"#12355B\",\n      face = \"bold\",\n      size = 14,\n      vjust = -0.5\n    )\n  ) +\n  annotate(\n    'text',\n    x = as.Date(\"2022-01-03\"),\n    y = my_breaks,\n    label = round(my_breaks, 2),\n    angle = 0,\n    hjust = -0.1,\n    vjust = 0.5\n  ) +\n  geom_segment(data = tick_data,\n               aes(\n                 x = x,\n                 xend = xend,\n                 y = y,\n                 yend = yend\n               ),\n               color = \"black\") +\n  transition_reveal(sample_date) +\n  ease_aes('linear')  # Easing to make the animation smoother\n\n# Render the animation and save as GIF\nanim <- animate(p, nframes = 100, fps = 10, renderer = gifski_renderer())\n\nanim\n```\n\n::: {.cell-output-display}\n![Animated polar chart of PM~10~ daily concentrations at Arrowtown, 2022. Dashed circle shows WHO guideline value. Dashed lines show seasons.](index_files/figure-html/fig-animation-1.gif){#fig-animation}\n:::\n:::\n\n\n## Make 4 animated plots\n\nNow let's check out whether other high PM~10~ sites also have similar seasonal dynamics in air quality (we'll also use a different year to make sure) (@fig-top4).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_4 <- dat |> \n  filter(indicator == \"PM10\") |> # just look at PM10\n  group_by(site_name) |> \n  summarize(max_concentration = max(concentration, na.rm = TRUE)) |> # get max conc. per site\n  arrange(desc(max_concentration)) |> # sort descending\n  top_n(4, max_concentration)\n\np2 <- dat |> \n  filter(site_name %in% top_4$site_name) |> \n  filter(indicator == \"PM10\") |> \n  filter(year == 2019) |>\n  arrange(sample_date) |> \n  mutate(sample_date = as.Date(sample_date)) |> \n  ggplot() +\n    geom_hline(yintercept = 45, linetype = \"dashed\", color = \"red\", alpha = 0.7) +\n    geom_line(aes(x = sample_date, y = concentration), color = \"#D72638\", size = 0.5) +\n    geom_point(aes(x = sample_date, y = concentration), color = \"#420039\", size = 2) +\n    scale_x_date(date_labels = \"%b\", date_breaks = \"1 month\") +\n    coord_curvedpolar() +\n    theme_minimal() +\n    labs(x = \"\", \n         y = bquote(\"Daily PM\"[10] * \" concentration (µg/m\"^3 * \")\")) +\n    transition_reveal(sample_date) +\n    ease_aes('linear') +\n    facet_wrap(~site_name, scales = \"free_y\")\n\n# Render the animation and save as GIF\nanim2 <- animate(p2, nframes = 100, fps = 10, renderer = gifski_renderer())\n\nanim2\n```\n\n::: {.cell-output-display}\n![Animated polar chart of PM~10~ daily concentrations at Arrowtown, Invercargill, Lower Hutt, and Milton, 2019. Dashed circle shows WHO guideline value. Note the y-axes differ between plots.](index_files/figure-html/fig-top4-1.gif){#fig-top4}\n:::\n:::\n\n\nSome interesting results here.[^1] Firstly, Arrowtown demonstrates similar seasonal dynamics to 2022, with low concentrations in summer and a number of exceedances during winter. Invercargill also shows similar seasonality, albeit at lower concentrations.\n\n[^1]: Note the y-axes differ between each site. This is due to the large magnitude in differences. My goal here was to explore the relative seasonality between each site, so having free axes makes sense. If the goal was instead to explore relative magnitudes between each site, I could have simply set `facet_wrap(~site_name, scales = \"fixed\")`.\n\nLower Hutt remains well below the guideline all year-round, but exhibits reversed seasonality, with higher concentrations in summer. It's worth noting that Lower Hutt is included in the top four due to a single large spike in 2022, so it might be reasonable to exclude this site from further analysis.\n\nMilton is particularly interesting as it has numerous exceedances during winter but appears not to monitor air quality during summer (this trend is true in other years as well).\n\n## Next steps\n\nThis analysis has provided some interesting insights into the seasonality of PM~10~ concentrations in New Zealand. The next steps could involve:\n\n- Conduct a formal test for seasonality between sites. \n- Classify sites into categories such as 'high-summer', 'high-winter', 'high-all-year-round', or 'low'.\n- Produce animations for all sites on a map. \n- Investigate causes of seasonality (latitude?).\n- Repeat analyses for PM~2.5~.\n- Put multiple years on single graph. \n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/leaflet-binding-2.2.2/leaflet.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
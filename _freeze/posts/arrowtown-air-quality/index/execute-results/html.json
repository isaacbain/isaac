{
  "hash": "4fd2bb81e1f80de68309aa17572c5c85",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Arrowtown air quality\"\nauthor: \"Isaac Bain\"\ndate: \"2024-05-31\"\ncategories: [code, air quality, animation]\nexecute:\n  warning: false\n  error: false\nformat: \n  html:\n    code-fold: show\n    code-summary: \"Show the code\"\neditor: visual\n---\n\n\n## Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # provides ggplot, dplyr, etc\nlibrary(janitor) # tidy up messy variable names\nlibrary(gganimate) # provides animations\nlibrary(geomtextpath) # makes labels curved on polar graph\n```\n:::\n\n\n## Import data\n\n[Land, Air, Water Aotearoa (LAWA)](https://lawa.org.nz/) is a collaboration between New Zealand's 16 regional councils and unitary authorities, the Cawthron Institute, the Ministry for the Environment, the Department of Conservation, and Stats NZ.\n\nIt provides state of the environment monitoring data for a number of [environmental domains](https://lawa.org.nz/explore-data), including:\n\n1.  swimming water quality,\n\n2.  estuary health,\n\n3.  groundwater quality,\n\n4.  lake quality,\n\n5.  land cover,\n\n6.  river quality,\n\n7.  water quantity,\n\nand of particular interest here, air quality.\n\nLAWA make their data freely available at <https://lawa.org.nz/download-data>, from which I downloaded an excel sheet of air quality for the period 2016-2022. They only have PM~10~ and PM~2.5~ parameters available for now.\n\nParticulate matter (PM) can have adverse effects on human health and the environment. The numbers 10 and 2.5 refer to the diameter of the particles in micrometers (µm).\n\n::: {.callout-note collapse=\"false\"}\n## What are the human health impacts of PM in New Zealand?\n\nHales et al. (2021) did a retrospective cohort epidemiological study of the association between PM~2.5~, NO~2~ and mortality and morbidity for 2.2m New Zealanders. They found that exposure to PM~2.5~ per 10 μg/m^3^ increased the risk of death by 11% (95% CI 7-15%) and increased the risk of ischaemic heart disease by 29% (95% CI 23-35%).\n\nHales, S., Atkinson, J., Metcalfe, J., Kuschel, G., & Woodward, A. (2021). Long term exposure to air pollution, mortality and morbidity in New Zealand: cohort study. *Science of The Total Environment, 801*, 149660.\n:::\n\n|                    |                                                                                                                                                                                                                                                                                                                       |\n|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| **PM~10~**         |                                                                                                                                                                                                                                                                                                                       |\n| **Definition**     | PM~10~ refers to particulate matter with a diameter of 10 micrometers or less.                                                                                                                                                                                                                                        |\n| **Sources**        | These particles are usually produced by mechanical processes such as construction activities, road dust, industrial processes, and natural sources like pollen and sea spray.                                                                                                                                         |\n| **Health Effects** | PM~10~ particles can be inhaled into the lungs, causing respiratory issues, aggravating asthma, and other lung diseases. They can also affect cardiovascular health.                                                                                                                                                  |\n| **Regulations**    | Many countries have set air quality standards for PM~10~ to protect public health. For instance, the World Health Organization (WHO) recommends that the 24-hour mean concentration of PM~10~ should not exceed 45 µg/m³.                                                                                             |\n| **PM~2.5~**        |                                                                                                                                                                                                                                                                                                                       |\n| **Definition**     | PM~2.5~ refers to particulate matter with a diameter of 2.5 micrometers or less.                                                                                                                                                                                                                                      |\n| **Sources**        | These finer particles are often produced by combustion processes such as vehicle emissions, power plants, residential heating, industrial activities, and wildfires. Secondary particles can also form in the atmosphere from chemical reactions involving gases like sulfur dioxide (SO₂) and nitrogen oxides (NOx). |\n| **Health Effects** | PM~2.5~ particles are more dangerous than PM10 because they can penetrate deeper into the respiratory tract, reaching the alveoli in the lungs. Long-term exposure to PM~2.5~ is associated with increased rates of chronic bronchitis, lung cancer, heart disease, and can also impact cognitive function.           |\n| **Regulations**    | WHO guidelines suggest that the annual mean concentration of PM~2.5~ should not exceed 10 µg/m³, and the 24-hour mean should not exceed 25 µg/m³.                                                                                                                                                                     |\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- readxl::read_xlsx(\"data/airqualitydownloaddata_2016-2022.xlsx\",\n                         sheet = \"Air Quality Data\") |> \n  clean_names() |> \n  mutate(year = year(sample_date)) |>\n  filter(!is.na(sample_date) & !is.na(concentration))\n```\n:::\n\n\n## What are the worst sites?\n\nAir quality is known to be worst in more southern areas, places where home heating via wood burning or coal is more prevalent, and over the colder months of the year.\n\nBut let's check some of these assumptions by extracting the worst 5 sites for maximum recorded PM~10~ values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat |> \n  filter(indicator == \"PM10\") |>\n  group_by(site_name) |> \n  summarize(max_concentration = max(concentration, na.rm = TRUE)) |> \n  arrange(desc(max_concentration)) |> \n  top_n(5, max_concentration)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 2\n  site_name                       max_concentration\n  <chr>                                       <dbl>\n1 Milton                                       203.\n2 Arrowtown                                    158.\n3 Lower Hutt (Phil Evans Reserve)              155.\n4 Invercargill at Pomona Street                139.\n5 Washdyke Alpine                              123.\n```\n\n\n:::\n:::\n\n\nIndeed most of these locations are in South Island (except for Lower Hutt, which is at the bottom of the North Island).\n\n## Static plot of seasonal air quality\n\nNow let's check the assumption that air quality is worse in the colder months of the year. Here I'm plotting daily PM10 concentrations over 2022 for one site (Arrowtown). And there is quite a spike over the winter months, with a number of exceedances of the WHO guideline of 45 µg/m³.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_filtered <- dat |> \n  filter(site_name == \"Arrowtown\") |> \n  filter(indicator == \"PM10\") |> \n  filter(year == 2022) |>\n  arrange(sample_date) |> \n  mutate(sample_date = as.Date(sample_date))\n\n# Calculate the breaks for y-axis labels\nn_breaks <- 5\nmy_breaks <- scales::breaks_extended(n = n_breaks)(range(dat_filtered$concentration))\nmy_breaks <- my_breaks[my_breaks > 0]\n\n# Create a data frame for the tick marks\ntick_data <- data.frame(\n  x = as.Date(\"2022-01-01\"),\n  xend = as.Date(\"2022-01-03\"),\n  y = my_breaks,\n  yend = my_breaks\n)\n\nggplot(dat_filtered) +\n  geom_hline(yintercept = 45, linetype = \"dashed\", color = \"red\", alpha = 0.7) +\n  geom_line(aes(x = sample_date, y = concentration),\n            color = \"#D72638\",\n            size = 0.5) +\n  scale_x_date(date_labels = \"%b\", date_breaks = \"1 month\") +\n  #coord_curvedpolar() +\n  labs(\n    title = bquote(\"Daily PM\"[10] * \" concentration (µg/m\"^3 * \") in Arrowtown, 2022\"),\n    x = \"\",\n    y = bquote(\"Daily PM\"[10] * \" concentration (µg/m\"^3 * \")\")\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(hjust = 0.5, \n                              colour = \"#420039\"),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.text.x = element_text(\n      color = \"#12355B\",\n      face = \"bold\",\n      size = 14,\n      vjust = -0.5\n    )\n  ) +\n  annotate(\n    'text',\n    x = as.Date(\"2022-01-03\"),\n    y = my_breaks,\n    label = round(my_breaks, 2),\n    angle = 0,\n    hjust = -0.1,\n    vjust = 0.5\n  ) +\n  geom_segment(data = tick_data,\n               aes(\n                 x = x,\n                 xend = xend,\n                 y = y,\n                 yend = yend\n               ),\n               color = \"black\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## Make an animated plot\n\nLet's jazz it up; by making it animated - revealing the daily concentrations over time, and making it a polar chart - which are particularly effective at emphasising the cyclical nature of seasonal air quality.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define the start dates for each season according to New Zealand definitions\nseason_start_dates <- as.Date(c(\"2022-12-01\", \"2022-03-01\", \"2022-06-01\", \"2022-09-01\"))\n\n# Create the plot with seasonal division lines and y-axis labels inside the chart\np <- ggplot(dat_filtered) +\n  geom_hline(yintercept = 45, linetype = \"dashed\", color = \"red\", alpha = 0.7) +\n  geom_line(aes(x = sample_date, y = concentration),\n            color = \"#D72638\",\n            size = 0.5) +\n  geom_vline(\n    xintercept = as.numeric(season_start_dates),\n    linetype = \"dashed\",\n    color = \"black\",\n    alpha = 0.3\n  ) +\n  geom_point(aes(x = sample_date, y = concentration), color = \"#420039\", size = 2) +\n  scale_x_date(date_labels = \"%b\", date_breaks = \"1 month\") +\n  coord_curvedpolar() +\n  labs(\n    title = bquote(\"Daily PM\"[10] * \" concentration (µg/m\"^3 * \") in Arrowtown, 2022\"),\n    x = \"\",\n    y = \"\"\n  ) +\n  theme_minimal() +\n  theme(\n    plot.title = element_text(hjust = 0.5, \n                              colour = \"#420039\"),\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank(),\n    axis.text.x = element_text(\n      color = \"#12355B\",\n      face = \"bold\",\n      size = 14,\n      vjust = -0.5\n    )\n  ) +\n  annotate(\n    'text',\n    x = as.Date(\"2022-01-03\"),\n    y = my_breaks,\n    label = round(my_breaks, 2),\n    angle = 0,\n    hjust = -0.1,\n    vjust = 0.5\n  ) +\n  geom_segment(data = tick_data,\n               aes(\n                 x = x,\n                 xend = xend,\n                 y = y,\n                 yend = yend\n               ),\n               color = \"black\") +\n  transition_reveal(sample_date) +\n  ease_aes('linear')  # Easing to make the animation smoother\n\n# Render the animation and save as GIF\nanim <- animate(p, nframes = 100, fps = 10, renderer = gifski_renderer())\n\nanim\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.gif)\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}